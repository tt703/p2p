{% extends "layout.html" %}
{% block body %}
<style>
.chat-container {
    display: flex;
    height: 100vh;
    width: 100vw;
    border: 1px solid #ddd;
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
}

    /* Left Panel: Chat List */
    .chat-list {
        width: 30%;
        background-color: #072762;
        padding: 1em;
        border-right: 1px solid #ddd;
        overflow-y: auto;
        color: #fff;
    }

    .chat-list h3 {
        font-size: 1.2em;
        color: #f0f0f0;
        margin-bottom: 1em;
    }

    .chat-item {
        display: flex;
        align-items: center;
        padding: 0.8em;
        text-decoration: none;
        color: #f0f0f0;
        border-radius: 8px;
        transition: background-color 0.3s;
        cursor: pointer;
    }

    .chat-item:hover {
        background-color: #305f9e;
    }

    .chat-avatar {
        background-color: #007bff;
        color: white;
        font-weight: bold;
        font-size: 1.2em;
        width: 35px;
        height: 35px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 0.8em;
    }

    .chat-info {
        display: flex;
        flex-direction: column;
    }

    .chat-name {
        font-weight: 600;
        color: #f0f0f0;
    }

    .chat-preview {
        font-size: 0.9em;
        color: #cfcfcf;
    }

    /* Right Panel: Chat Detail */
    .chat-box {
        flex: 1;
        display: flex;
        flex-direction: column;
        background-color: #fff;
    }

    .chat-header {
        padding: 0.5em;
        border-bottom: 1px solid #ddd;
        color: #007bff;
        font-size: 1.2em;
        font-weight: bold;
        text-align: center;
    }

    .chat-messages {
        flex: 1;
        overflow-y: auto;
        padding: 1em;
        background-color: #f7f9fc;
    }

    .message {
        margin: 0.5em 0;
        max-width: 70%;
        padding: 0.7em;
        border-radius: 12px;
        font-size: 0.9em;
        color: #333;
    }

 .sent {
    background-color: rgba(144, 238, 144, 0.8);
    align-self: flex-end;
    text-align: right;
    border-radius: 12px 12px 0 12px;
    margin-left: auto;
}


.received {
    background-color: #f1f1f1;
    align-self: flex-start;
    text-align: left;
    border-radius: 12px 12px 12px 0;
    margin-right: auto;
}

    /* Message Input */
    #message-form {
        display: flex;
        padding: 0.5em;
        border-top: 1px solid #ddd;
        background-color: #f7f9fc;
    }

    #message-content {
        flex: 1;
        padding: 0.6em;
        border: 1px solid #ddd;
        border-radius: 20px;
        outline: none;
        font-size: 1em;
    }

    #message-form button {
        margin-left: 0.5em;
        padding: 0.5em 1em;
        background-color: #007bff;
        color: white;
        border: none;
        border-radius: 20px;
        cursor: pointer;
    }
</style>

<div class="chat-container">
    <!-- Chat List -->
    <div class="chat-list">
        <h3>Your Chats</h3>
        {% for chat in chats %}
        <div class="chat-item" onclick="loadChatDetail({{ chat.id }})">
            <div class="chat-avatar">{{ chat.username|slice:":1" }}</div>
            <div class="chat-info">
                <span class="chat-name">{{ chat.username }}</span>
                <span class="chat-preview">{% if chat.student.is_online %}Online{% else %}Offline{% endif %}</span>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- Chat Detail -->
    <div class="chat-box">
        <div class="chat-header" id="chat-with">Select a chat to start messaging</div>
        <div class="chat-messages" id="chat-messages"></div>
       <form id="message-form" onsubmit="sendMessage(event)" style="display: flex;">
    {% csrf_token %}
    <input type="text" id="message-content" placeholder="Type a message..." required>
    <button type="submit" style="z-index: 1;">Send</button>
</form>
    </div>
</div>

<script>
    let currentChatId = null;

    function loadChatDetail(chatId) {
        currentChatId = chatId;
        fetch(`/chat/${chatId}/messages/`)
            .then(response => response.json())
            .then(data => {
                const chatMessages = document.getElementById("chat-messages");
                chatMessages.innerHTML = "";  // Clear current messages

                data.messages.forEach(message => {
                    const messageElement = document.createElement("div");
                    messageElement.classList.add("message", message.is_sent ? "sent" : "received");
                    messageElement.textContent = message.content;
                    chatMessages.appendChild(messageElement);
                });

                document.getElementById("chat-with").textContent = data.chat_with;
                document.getElementById("message-form").style.display = "flex"; // Show the message form
            })
            .catch(error => console.error("Error loading chat details:", error));
    }

    function sendMessage(event) {
        event.preventDefault();
        const content = document.getElementById("message-content").value;

        fetch(`/chat/${currentChatId}/send/`, {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": "{{ csrf_token }}"
            },
            body: JSON.stringify({ content: content })
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                console.error("Error:", data.error);
            } else {
                loadChatDetail(currentChatId);
                document.getElementById("message-content").value = "";
            }
        })
        .catch(error => console.error("Error sending message:", error));
    }
</script>
{% endblock %}
